import 'package:esc_pos_utils/esc_pos_utils.dart';
import 'package:flutter/material.dart';
import 'dart:ffi';

import 'package:flutter_blue_plus/flutter_blue_plus.dart' as blue;
import 'package:flutter_blue_plus/flutter_blue_plus.dart';
import 'package:intl/intl.dart';
import 'package:primos_app/widgets/styledButton.dart';
import 'dart:typed_data';
import 'package:flutter/services.dart';
import 'dart:math';

class PrintPage extends StatefulWidget {
  final String? formattedDate;
  final String? orderName;
  final String? receiptNum;
  final String? waiterName;
  final List<dynamic>? orderDetails;
  final double? subtotal;
  final double? vatAmount;
  final double? discountAmount;
  final double? grandTotal;
  final String? cashierName;
  final double? amountReceived;
  final double? changeAmount;

  const PrintPage(
      {super.key,
      this.formattedDate,
      this.orderName,
      this.receiptNum,
      this.waiterName,
      this.orderDetails,
      this.subtotal,
      this.vatAmount,
      this.discountAmount,
      this.grandTotal,
      this.cashierName,
      this.amountReceived,
      this.changeAmount});

  @override
  State<PrintPage> createState() => _PrintPageState();
}

class _PrintPageState extends State<PrintPage> {
  // List<BluetoothDevice> discoveredDevices = [];

  blue.BluetoothDevice? connectedDevice; // Track the connected device

  BluetoothCharacteristic? printCharacteristic;

  // ... Rest of your code ...

  void _connectToDevice(blue.BluetoothDevice device) async {
    try {
      await device.connect(autoConnect: false);
      setState(() {
        connectedDevice = device;
        print(connectedDevice);
      });

      // Note: You must call this again if disconnected!
      List<BluetoothService> services = await device.discoverServices();
      services.forEach((service) {
        print(service);
        for (BluetoothCharacteristic characteristic
            in service.characteristics) {
          if (characteristic.characteristicUuid ==
                  Guid('0000ae3b-0000-1000-8000-00805f9b34fb') ||
              characteristic.characteristicUuid ==
                  Guid('0000ae3c-0000-1000-8000-00805f9b34fb')) {
            printCharacteristic = characteristic;
            break;
          }
        }
      });

      if (printCharacteristic == null) {
        print('Printing characteristic not found.');
      }
    } catch (e) {
      print('Error connecting to device: $e');
    }
  }

  void _disconnectDevice(blue.BluetoothDevice device) async {
    try {
      await device.disconnect();
      setState(() {
        connectedDevice = null;
      });
    } catch (e) {
      print('Error disconnecting from device: $e');
    }
  }

  List<int> testTicket(Generator generator) {
    List<int> bytes = [];

    bytes += generator.text(
        'Regular: aA bB cC dD eE fF gG hH iI jJ kK lL mM nN oO pP qQ rR sS tT uU vV wW xX yY zZ');

    bytes += generator.feed(2);
    bytes += generator.cut();
    return bytes;
  }

  void _printReceipt() async {
    if (connectedDevice != null) {
      try {
        final profile = await CapabilityProfile.load();
        final paper = PaperSize.mm58; // Choose the paper size you need

        final generator = Generator(PaperSize.mm58, profile);
        final bytes =
            testTicket(generator); // Use the generated receipt content

        if (printCharacteristic != null) {
          final mtuSize =
              20; // Adjust this value based on your Bluetooth device's MTU
          final chunks =
              _splitDataIntoChunks(Uint8List.fromList(bytes), mtuSize);

          for (final chunk in chunks) {
            await printCharacteristic!.write(chunk, withoutResponse: true);
          }
          // Disconnect after printing
          await connectedDevice!.disconnect();

          print('Receipt sent to printer successfully.');
        } else {
          print('Printing characteristic not found.');
        }
      } catch (e) {
        print('Error sending receipt: $e');
      }
    } else {
      print('No connected printer.');
    }
  }

  List<Uint8List> _splitDataIntoChunks(Uint8List data, int mtuSize) {
    final chunks = <Uint8List>[];
    for (int i = 0; i < data.length; i += mtuSize) {
      final chunkEndIndex = i + mtuSize;
      final chunk = data.sublist(i, chunkEndIndex.clamp(0, data.length));
      chunks.add(chunk);
    }
    return chunks;
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text("PRINTER TEST"),
      ),
      body: SafeArea(
        child: SingleChildScrollView(
          child: Column(
            children: <Widget>[
              StreamBuilder<List<blue.ScanResult>>(
                stream: blue.FlutterBluePlus.scanResults,
                initialData: [],
                builder: (context, snapshot) {
                  if (snapshot.hasData) {
                    return ListView.builder(
                      shrinkWrap: true,
                      itemCount: snapshot.data!.length,
                      itemBuilder: (context, index) {
                        final data = snapshot.data![index];
                        final isConnected = connectedDevice == data.device;

                        return Card(
                          elevation: 2,
                          child: ListTile(
                            onTap: () {
                              data.device.connect();
                            },
                            title: Text(data.device.localName),
                            subtitle: Text(data.device.remoteId.str),
                            trailing: ElevatedButton(
                              onPressed: isConnected
                                  ? () => _disconnectDevice(data.device)
                                  : () => _connectToDevice(data.device),
                              child:
                                  Text(isConnected ? 'DISCONNECT' : 'CONNECT'),
                            ),
                          ),
                        );
                      },
                    );
                  } else {
                    return Center(
                      child: Text("No devices found"),
                    );
                  }
                },
              ),
              StyledButton(
                  btnText: "PRINT",
                  onClick: () {
                    _printReceipt();
                  })
            ],
          ),
        ),
      ),
      floatingActionButton: StreamBuilder<bool>(
        stream: blue.FlutterBluePlus.isScanning,
        initialData: false,
        builder: (c, snapshot) {
          if (snapshot.data ?? false) {
            return FloatingActionButton(
              child: const Icon(Icons.stop),
              onPressed: () async {
                try {
                  blue.FlutterBluePlus.stopScan();
                } catch (e) {
                  print(e);
                }
              },
              backgroundColor: Colors.red,
            );
          } else {
            return FloatingActionButton(
                child: const Text("SCAN"),
                onPressed: () async {
                  try {
                    if (blue.FlutterBluePlus.isScanningNow == false) {
                      blue.FlutterBluePlus.startScan(
                        timeout: const Duration(seconds: 15),
                      );

                      print("executed");
                    }
                  } catch (e) {
                    print(e);
                  }
                  setState(() {}); // force refresh of connectedSystemDevices
                });
          }
        },
      ),
    );
  }
}
